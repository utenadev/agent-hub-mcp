# SPEC-014: 包括的リファクタリングとアーキテクチャの整理

## 1. 概要
v0.0.4までの急速な機能追加により蓄積された技術的負債を解消し、保守性とテスト容易性を向上させるために、コードベースの構造を整理する。機能的な変更（挙動の変化）は一切行わず、純粋なリファクタリングに徹する。

## 2. リファクタリング・タスク

### 2.1 CLIコマンドの分離 (cmd/agent-hub)
`main.go` に集中しているサブコマンドのロジックを、独立したファイルに分割する。
- `main.go`: エントリポイント、コマンド分岐、共通フラグ定義。
- `serve.go`: `runServe` 関連のロジック。
- `orchestrator.go`: `runOrchestrator` 関連のロジック。
- `doctor.go`: `runDoctor` 関連のロジック。
- `setup.go`: `runSetup` 関連のロジック。
- `help.go`: `runHelp` 関連のロジック。

### 2.2 設定管理の一元化 (internal/config)
分散している設定（デフォルトパス、APIキー、環境変数）を管理する新パッケージを作成する。
- `internal/config/config.go`: `Config` 構造体の定義、`Load()` 関数（環境変数・フラグ・JSONの統合読み込み）、`GetDefaultDBPath()` 等の実装。

### 2.3 データベース層のドメイン分割 (internal/db)
`db.go` に巨大化しているメソッドを、ドメインごとに分割する。
- `db.go`: `DB` 構造体の定義、`Open`/`Close`/`CheckIntegrity` 等の基本操作。
- `topic.go`: トピック関連の CRUD。
- `message.go`: メッセージ関連の CRUD、未読カウント。
- `presence.go`: エージェントの存在確認、ステータス更新。
- `summary.go`: トピック要約の保存・取得。

### 2.4 依存注入 (DI) の洗練
`App` 構造体および各サブコマンドにおいて、IO（stdout/stderr）やデータベース、設定オブジェクトの受け渡しをより明示的で一貫したパターンに統一する。

## 3. 実施上のルール
- **TDDの維持**: 各タスクの実行後、必ず `go test ./...` が全てパスすることを確認する。
- **機能不変**: ユーザーから見える出力メッセージ、フラグ名、挙動は変更しない。
- **段階的実行**: 1つのタスクごとにコミット・確認を行い、大規模な破壊を避ける。

## 4. 推奨手順
1. `internal/db` の分割。
2. `internal/config` の新設と設定ロジックの移行。
3. `cmd/agent-hub` の分割とDIの整理。
4. 全体のテストと統合確認。
